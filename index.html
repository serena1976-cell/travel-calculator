<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…äººè¨˜å¸³æœ¬ V6.0</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        /* åŸºç¤è¨­å®š */
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --gray: #6c757d; --bg: #f4f7f6; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: #333; -webkit-font-smoothing: antialiased; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.05); padding-bottom: 80px; }
        
        /* å°è¦½åˆ— */
        .navbar { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .navbar h1 { margin: 0; font-size: 18px; font-weight: 600; }
        .nav-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; backdrop-filter: blur(5px); }
        
        /* é é¢åˆ‡æ›èˆ‡å‹•ç•« */
        .page { display: none; padding: 20px; animation: fadeIn 0.2s ease-out; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡æ¨£å¼ */
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .trip-card { cursor: pointer; transition: transform 0.2s; position: relative; }
        .trip-card:active { transform: scale(0.98); }
        .trip-title { font-weight: bold; font-size: 18px; margin-bottom: 5px; color: #2c3e50; }
        .trip-meta { font-size: 13px; color: #888; display: flex; justify-content: space-between; align-items: flex-end; }
        .total-badge { background: #e3f2fd; color: var(--primary); padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 15px; }

        /* è¡¨å–®å…ƒç´  */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #555; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fff; appearance: none; }
        input:focus, select:focus { border-color: var(--primary); outline: none; }

        /* å¹£åˆ¥åˆ‡æ›æŒ‰éˆ•çµ„ */
        .currency-toggle { display: flex; gap: 10px; margin-bottom: 10px; }
        .toggle-btn { flex: 1; padding: 10px; border: 1px solid #ddd; background: #fff; border-radius: 8px; cursor: pointer; font-weight: bold; color: #666; transition: all 0.2s; }
        .toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,123,255,0.3); }

        /* æŒ‰éˆ• */
        .btn-block { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #fee2e2; color: #991b1b; padding: 5px 10px; border-radius: 4px; font-size: 12px; border: none; position: absolute; top: 15px; right: 15px; }

        /* åˆ—è¡¨é …ç›® */
        .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .expense-left h4 { margin: 0 0 4px 0; font-size: 16px; color: #333; }
        .expense-tag { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #555; margin-right: 5px; }
        .expense-date { font-size: 12px; color: #999; }
        .expense-right { text-align: right; }
        .twd-cost { font-weight: bold; font-size: 16px; color: #333; }
        .origin-cost { font-size: 12px; color: #888; }

        /* è¦–è¦ºåŒ–åœ–è¡¨æ¢ */
        .chart-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 13px; }
        .chart-label { width: 70px; color: #555; }
        .chart-bar-bg { flex: 1; background: #eee; height: 12px; border-radius: 6px; overflow: hidden; margin: 0 10px; }
        .chart-bar-fill { height: 100%; background: var(--primary); border-radius: 6px; width: 0%; transition: width 0.5s; }
        .chart-val { width: 60px; text-align: right; color: #333; font-weight: bold; }

        /* æ‡¸æµ®æŒ‰éˆ• */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 15px rgba(0,123,255,0.4); border: none; cursor: pointer; z-index: 999; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="page-home" class="page active">
        <div class="navbar">
            <h1>âœˆï¸ æ—…äººè¨˜å¸³æœ¬</h1>
            <button class="nav-btn" onclick="exportBackup()">å‚™ä»½å…¨è³‡æ–™</button>
        </div>
        
        <div id="trip-list" style="padding-top: 20px;">
            </div>

        <button class="fab" onclick="showCreateModal()">ï¼‹</button>
    </div>

    <div id="page-create" class="page" style="background:white; position:fixed; inset:0; z-index:200;">
        <div class="navbar" style="background:white; color:#333; border-bottom:1px solid #eee;">
            <h1>å»ºç«‹æ–°æ—…ç¨‹</h1>
            <button class="nav-btn" style="color:#666; border:1px solid #ddd;" onclick="goHome()">å–æ¶ˆ</button>
        </div>
        <div style="padding: 20px;">
            <div class="form-group">
                <label>æ—…ç¨‹åç¨±</label>
                <input type="text" id="newTripName" placeholder="ä¾‹å¦‚ï¼š2025 äº¬éƒ½è³æ¥“">
            </div>
            <div class="form-group">
                <label>ç•¶åœ°ä¸»è¦è²¨å¹£ (é è¨­å¤–å¹£)</label>
                <select id="newTripCurrency">
                    <option value="JPY">ğŸ‡¯ğŸ‡µ æ—¥åœ“ (JPY)</option>
                    <option value="USD">ğŸ‡ºğŸ‡¸ ç¾é‡‘ (USD)</option>
                    <option value="KRW">ğŸ‡°ğŸ‡· éŸ“å…ƒ (KRW)</option>
                    <option value="EUR">ğŸ‡ªğŸ‡º æ­å…ƒ (EUR)</option>
                    <option value="CNY">ğŸ‡¨ğŸ‡³ äººæ°‘å¹£ (CNY)</option>
                    <option value="THB">ğŸ‡¹ğŸ‡­ æ³°éŠ– (THB)</option>
                    <option value="GBP">ğŸ‡¬ğŸ‡§ è‹±éŠ (GBP)</option>
                </select>
            </div>
            <button class="btn-block btn-primary" onclick="createTrip()">é–‹å§‹è¨˜å¸³</button>
        </div>
    </div>

    <div id="page-detail" class="page">
        <div class="navbar">
            <button class="nav-btn" onclick="goHome()">â¬… è¿”å›</button>
            <h1 id="detailTitle">è©³ç´°è³‡æ–™</h1>
            <button class="nav-btn" onclick="exportExcel()">åŒ¯å‡ºå ±è¡¨</button>
        </div>

        <div class="card" style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; margin-top: 20px;">
            <div style="font-size: 14px; opacity: 0.9;">ç›®å‰ç¸½æ”¯å‡º (TWD)</div>
            <div style="font-size: 32px; font-weight: bold; margin-top: 5px;" id="displayTotalTWD">0</div>
            <div style="font-size: 13px; opacity: 0.8; margin-top: 10px;" id="displayDetailInfo">çµ±è¨ˆä¸­...</div>
        </div>

        <div class="card">
            <h3 style="margin: 0 0 15px 0; font-size: 16px; color: var(--primary);">ğŸ–Šï¸ æ–°å¢ä¸€ç­†æ¶ˆè²»</h3>
            
            <div class="form-group">
                <label>é¡åˆ¥</label>
                <select id="inputCategory">
                    <option value="é¤é£²">ğŸ” é¤é£²ç¾é£Ÿ</option>
                    <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©æ¶ˆè²»</option>
                    <option value="äº¤é€š">ğŸš† äº¤é€šç§»å‹•</option>
                    <option value="ä½å®¿">ğŸ¨ ä½å®¿é£¯åº—</option>
                    <option value="é–€ç¥¨">ğŸŸï¸ é–€ç¥¨é«”é©—</option>
                    <option value="é›œé …">ğŸ“¦ å…¶ä»–é›œé …</option>
                </select>
            </div>

            <div class="form-group">
                <label>æ”¯ä»˜æ–¹å¼</label>
                <div class="currency-toggle">
                    <button class="toggle-btn active" id="btnForeign" onclick="setCurrencyMode('FOREIGN')">ç•¶åœ°è²¨å¹£</button>
                    <button class="toggle-btn" id="btnHome" onclick="setCurrencyMode('HOME')">å°å¹£æ”¯ä»˜</button>
                </div>
            </div>

            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>é‡‘é¡</label>
                    <input type="number" id="inputAmount" placeholder="å¤šå°‘éŒ¢">
                </div>
                <div style="flex:1;" id="rateInputGroup">
                    <label>åŒ¯ç‡</label>
                    <input type="number" id="inputRate" step="0.0001" placeholder="åŒ¯ç‡">
                </div>
            </div>

            <div class="form-group">
                <label>é …ç›®èªªæ˜ (é¸å¡«)</label>
                <input type="text" id="inputItem" placeholder="ä¾‹å¦‚: ä¸€è˜­æ‹‰éºµ">
            </div>
            
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="inputDate">
            </div>

            <button class="btn-block btn-primary" onclick="addExpense()">åŠ å…¥æ¸…å–®</button>
        </div>

        <div class="card">
            <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #666;">ğŸ“Š èŠ±è²»åˆ†ä½ˆ</h3>
            <div id="chartContainer">
                </div>
        </div>

        <div class="card">
            <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #666;">ğŸ“œ æ¶ˆè²»æ˜ç´°</h3>
            <div id="expenseList"></div>
        </div>
    </div>

</div>

<script>
    // --- æ ¸å¿ƒè³‡æ–™ ---
    let trips = JSON.parse(localStorage.getItem('travelApp_v6')) || [];
    let currentTripId = null;
    let currentMode = 'FOREIGN'; // 'FOREIGN' (ç•¶åœ°) or 'HOME' (å°å¹£)
    
    // API ç¶²å€
    const API_URL = "https://open.er-api.com/v6/latest/";

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        renderTripList();
        document.getElementById('inputDate').valueAsDate = new Date();
    };

    function saveData() {
        localStorage.setItem('travelApp_v6', JSON.stringify(trips));
    }

    // --- é é¢è·¯ç”± ---
    function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        window.scrollTo(0,0);
    }
    
    function goHome() { switchPage('page-home'); renderTripList(); }
    function showCreateModal() { 
        document.getElementById('newTripName').value = ""; 
        switchPage('page-create'); 
    }

    // --- æ—…ç¨‹ç®¡ç† (é¦–é ) ---
    function createTrip() {
        const name = document.getElementById('newTripName').value;
        const currency = document.getElementById('newTripCurrency').value;
        if (!name) return alert("è«‹è¼¸å…¥æ—…ç¨‹åç¨±");

        const newTrip = {
            id: Date.now(),
            name,
            mainCurrency: currency,
            createdAt: new Date().toLocaleDateString(),
            expenses: [] 
        };

        trips.push(newTrip);
        saveData();
        
        // å˜—è©¦é æŠ“åŒ¯ç‡å­˜èµ·ä¾†ç•¶é è¨­å€¼
        fetch(API_URL + currency)
            .then(res => res.json())
            .then(data => {
                newTrip.lastRate = data.rates.TWD; 
                saveData();
            });

        goHome();
    }

    function deleteTrip(e, id) {
        e.stopPropagation();
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ—…ç¨‹ï¼Ÿè³‡æ–™å°‡ç„¡æ³•å¾©åŸã€‚")) {
            trips = trips.filter(t => t.id !== id);
            saveData();
            renderTripList();
        }
    }

    function renderTripList() {
        const list = document.getElementById('trip-list');
        list.innerHTML = "";
        
        if(trips.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">å°šæœªå»ºç«‹æ—…ç¨‹<br>é»æ“Šå³ä¸‹è§’æŒ‰éˆ•é–‹å§‹</div>`;
            return;
        }

        trips.forEach(trip => {
            // è¨ˆç®—ç¸½é¡
            const total = trip.expenses.reduce((sum, item) => sum + item.finalTWD, 0);
            
            const div = document.createElement('div');
            div.className = 'trip-card card';
            div.onclick = () => openTrip(trip.id);
            div.innerHTML = `
                <div class="trip-title">${trip.name}</div>
                <button class="btn-danger" onclick="deleteTrip(event, ${trip.id})">åˆªé™¤</button>
                <div class="trip-meta">
                    <span>${trip.createdAt} â€¢ ${trip.expenses.length} ç­†è³‡æ–™</span>
                    <span class="total-badge">NT$ ${Math.round(total).toLocaleString()}</span>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // --- è¨˜å¸³å…§é é‚è¼¯ ---
    function openTrip(id) {
        currentTripId = id;
        const trip = trips.find(t => t.id === id);
        
        document.getElementById('detailTitle').innerText = trip.name;
        
        // é‡ç½®è¡¨å–®
        document.getElementById('inputItem').value = "";
        document.getElementById('inputAmount').value = "";
        document.getElementById('inputDate').valueAsDate = new Date();
        
        // è¨­å®šæŒ‰éˆ•ç‹€æ…‹èˆ‡åŒ¯ç‡
        document.getElementById('btnForeign').innerText = `ç•¶åœ°è²¨å¹£ (${trip.mainCurrency})`;
        setCurrencyMode('FOREIGN'); // é è¨­ç‚ºå¤–å¹£æ¨¡å¼
        
        // è‹¥æœ‰å­˜éåŒ¯ç‡ï¼Œé å…ˆå¡«å…¥
        if(trip.lastRate) {
            document.getElementById('inputRate').value = parseFloat(trip.lastRate).toFixed(4);
        }

        renderDetailView();
        switchPage('page-detail');
    }

    function setCurrencyMode(mode) {
        currentMode = mode;
        const rateGroup = document.getElementById('rateInputGroup');
        const btnForeign = document.getElementById('btnForeign');
        const btnHome = document.getElementById('btnHome');
        
        if (mode === 'HOME') {
            // å°å¹£æ¨¡å¼
            rateGroup.style.display = 'none'; // éš±è—åŒ¯ç‡
            btnHome.classList.add('active');
            btnForeign.classList.remove('active');
        } else {
            // å¤–å¹£æ¨¡å¼
            rateGroup.style.display = 'block'; // é¡¯ç¤ºåŒ¯ç‡
            btnForeign.classList.add('active');
            btnHome.classList.remove('active');
        }
    }

    function addExpense() {
        const trip = trips.find(t => t.id === currentTripId);
        
        const category = document.getElementById('inputCategory').value;
        const item = document.getElementById('inputItem').value || category; // æ²’å¡«é …ç›®å°±ç”¨é¡åˆ¥å
        const amount = Number(document.getElementById('inputAmount').value);
        const date = document.getElementById('inputDate').value;
        
        let rate = 1;
        let finalTWD = 0;
        let currencyLabel = 'TWD';

        if (amount <= 0) return alert("è«‹è¼¸å…¥é‡‘é¡");

        if (currentMode === 'FOREIGN') {
            rate = Number(document.getElementById('inputRate').value);
            if (rate <= 0) return alert("è«‹è¼¸å…¥åŒ¯ç‡");
            finalTWD = amount * rate;
            currencyLabel = trip.mainCurrency;
            
            // æ›´æ–°è©²æ—…ç¨‹çš„æœ€æ–°åŒ¯ç‡ç´€éŒ„ï¼Œä¸‹æ¬¡è‡ªå‹•å¸¶å…¥
            trip.lastRate = rate;
        } else {
            // å°å¹£æ”¯ä»˜
            rate = 1;
            finalTWD = amount;
            currencyLabel = 'TWD';
        }

        trip.expenses.push({
            id: Date.now(),
            date,
            category,
            item,
            amount,     // åŸå¹£é‡‘é¡
            rate,       // åŒ¯ç‡
            currencyLabel, // ç´€éŒ„æ˜¯ TWD é‚„æ˜¯ JPY
            finalTWD    // ç®—å¥½çš„å°å¹£
        });

        saveData();
        
        // æ¸…ç©ºé‡‘é¡ï¼Œä¿ç•™æ—¥æœŸèˆ‡åŒ¯ç‡æ–¹ä¾¿é€£çºŒè¼¸å…¥
        document.getElementById('inputAmount').value = "";
        document.getElementById('inputItem').value = "";
        
        renderDetailView();
    }

    function deleteExpense(expenseId) {
        const trip = trips.find(t => t.id === currentTripId);
        trip.expenses = trip.expenses.filter(e => e.id !== expenseId);
        saveData();
        renderDetailView();
    }

    function renderDetailView() {
        const trip = trips.find(t => t.id === currentTripId);
        
        // 1. åˆ—è¡¨æ¸²æŸ“ (æŒ‰æ—¥æœŸé™åº)
        const listContainer = document.getElementById('expenseList');
        listContainer.innerHTML = "";
        const sortedList = [...trip.expenses].sort((a,b) => new Date(b.date) - new Date(a.date));

        sortedList.forEach(exp => {
            const div = document.createElement('div');
            div.className = 'expense-item';
            
            // åˆ¤æ–·é¡¯ç¤ºæ–‡å­—ï¼šå¦‚æœæ˜¯å°å¹£æ”¯ä»˜ï¼Œå°±ä¸é¡¯ç¤ºåŒ¯ç‡ç´°ç¯€
            let detailText = "";
            if(exp.currencyLabel === 'TWD') {
                detailText = `å°å¹£ç›´æ¥æ”¯ä»˜`;
            } else {
                detailText = `${exp.amount.toLocaleString()} ${exp.currencyLabel} Ã— ${exp.rate}`;
            }

            div.innerHTML = `
                <div class="expense-left">
                    <h4><span class="expense-tag">${exp.category}</span>${exp.item}</h4>
                    <span class="expense-date">${exp.date} â€¢ ${detailText}</span>
                </div>
                <div class="expense-right">
                    <div class="twd-cost">NT$ ${Math.round(exp.finalTWD).toLocaleString()}</div>
                    <button style="border:none; background:none; color:#ccc;" onclick="deleteExpense(${exp.id})">Ã—</button>
                </div>
            `;
            listContainer.appendChild(div);
        });

        // 2. çµ±è¨ˆè¨ˆç®—
        const totalTWD = trip.expenses.reduce((sum, e) => sum + e.finalTWD, 0);
        document.getElementById('displayTotalTWD').innerText = Math.round(totalTWD).toLocaleString();
        document.getElementById('displayDetailInfo').innerText = `å…± ${trip.expenses.length} ç­†æ¶ˆè²»`;

        // 3. åœ–è¡¨ç”Ÿæˆ (åˆ†é¡çµ±è¨ˆ)
        renderChart(trip.expenses, totalTWD);
    }

    function renderChart(expenses, total) {
        const container = document.getElementById('chartContainer');
        container.innerHTML = "";
        
        if (total === 0) {
            container.innerHTML = "<div style='text-align:center; color:#ccc; font-size:13px;'>å°šç„¡è³‡æ–™</div>";
            return;
        }

        // Group By Category
        const catMap = {};
        expenses.forEach(e => {
            if(!catMap[e.category]) catMap[e.category] = 0;
            catMap[e.category] += e.finalTWD;
        });

        // è½‰é™£åˆ—ä¸¦æ’åº (é‡‘é¡å¤§åˆ°å°)
        const catArray = Object.keys(catMap)
            .map(key => ({ name: key, val: catMap[key] }))
            .sort((a, b) => b.val - a.val);

        // ç¹ªè£½é•·æ¢
        catArray.forEach(cat => {
            const percent = (cat.val / total * 100).toFixed(1);
            const row = document.createElement('div');
            row.className = 'chart-row';
            row.innerHTML = `
                <div class="chart-label">${cat.name}</div>
                <div class="chart-bar-bg">
                    <div class="chart-bar-fill" style="width: ${percent}%"></div>
                </div>
                <div class="chart-val">${percent}%</div>
            `;
            container.appendChild(row);
        });
    }

    // --- åŒ¯å‡ºåŠŸèƒ½ ---
    function exportExcel() {
        const trip = trips.find(t => t.id === currentTripId);
        if (trip.expenses.length === 0) return alert("ç„¡è³‡æ–™å¯åŒ¯å‡º");

        const data = trip.expenses.map(e => ({
            "æ—¥æœŸ": e.date,
            "é¡åˆ¥": e.category,
            "é …ç›®èªªæ˜": e.item,
            "æ”¯ä»˜å¹£åˆ¥": e.currencyLabel,
            "åŸå¹£é‡‘é¡": e.amount,
            "åŒ¯ç‡": e.rate,
            "å°å¹£ç¸½é¡": Math.round(e.finalTWD)
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æ¶ˆè²»æ˜ç´°");
        XLSX.writeFile(wb, `${trip.name}_æ”¯å‡ºè¡¨.xlsx`);
    }

    function exportBackup() {
        const str = JSON.stringify(trips);
        const blob = new Blob([str], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "travel_backup_" + new Date().toISOString().slice(0,10) + ".json";
        a.click();
    }
</script>

</body>
</html>