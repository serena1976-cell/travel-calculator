<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…äººè¨˜å¸³æœ¬ V8.0 (ç·¨è¼¯åŠŸèƒ½ç‰ˆ)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        /* åŸºç¤è¨­å®š */
        :root { --primary: #007bff; --success: #28a745; --warning: #ffc107; --danger: #dc3545; --bg: #f4f7f6; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.05); padding-bottom: 100px; }
        
        /* å°è¦½åˆ— */
        .navbar { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .navbar h1 { margin: 0; font-size: 18px; font-weight: 600; }
        .nav-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; backdrop-filter: blur(5px); }
        
        /* é é¢åˆ‡æ› */
        .page { display: none; padding: 20px; animation: fadeIn 0.2s ease-out; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡èˆ‡åˆ—è¡¨ */
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .trip-card { cursor: pointer; transition: transform 0.2s; position: relative; }
        .trip-card:active { transform: scale(0.98); }
        .trip-title { font-weight: bold; font-size: 18px; margin-bottom: 5px; color: #2c3e50; }
        .trip-date { font-size: 13px; color: #666; margin-bottom: 8px; }
        .trip-meta { font-size: 13px; color: #888; display: flex; justify-content: space-between; align-items: flex-end; border-top: 1px solid #f0f0f0; padding-top: 8px; margin-top: 8px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; display: inline-block; }
        .badge-blue { background: #e3f2fd; color: var(--primary); }
        .badge-green { background: #e8f5e9; color: #2e7d32; }

        /* è¡¨å–®å…ƒç´  */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #555; }
        .form-row { display: flex; gap: 10px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fff; }
        input:focus, select:focus { border-color: var(--primary); outline: none; }

        /* å¹£åˆ¥åˆ‡æ› */
        .currency-toggle { display: flex; gap: 10px; margin-bottom: 10px; }
        .toggle-btn { flex: 1; padding: 10px; border: 1px solid #ddd; background: #fff; border-radius: 8px; cursor: pointer; font-weight: bold; color: #666; transition: all 0.2s; }
        .toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-block { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; background: var(--primary); color: white; transition: background 0.3s; }
        .btn-block.edit-mode { background: var(--warning); color: #333; } /* ç·¨è¼¯æ¨¡å¼è®Šè‰² */
        .btn-delete-trip { position: absolute; top: 15px; right: 15px; background: #fee2e2; color: #b91c1c; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        
        /* åˆ—è¡¨é …ç›® */
        .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .expense-tag { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: #f3f4f6; color: #333; margin-right: 5px; border: 1px solid #e5e7eb; }
        .pay-method { font-size: 11px; color: #fff; background: #adb5bd; padding: 1px 5px; border-radius: 3px; margin-left: 5px; }
        
        /* æ“ä½œæŒ‰éˆ• (ç·¨è¼¯/åˆªé™¤) */
        .action-btn { border: none; background: none; cursor: pointer; padding: 5px; margin-left: 5px; font-size: 16px; }
        .btn-edit { color: var(--warning); }
        .btn-del { color: #ccc; }

        /* åœ–è¡¨æ¢ */
        .chart-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 13px; }
        .chart-bar-bg { flex: 1; background: #eee; height: 12px; border-radius: 6px; overflow: hidden; margin: 0 10px; }
        .chart-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 15px rgba(0,123,255,0.4); border: none; cursor: pointer; z-index: 999; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="page-home" class="page active">
        <div class="navbar">
            <h1>âœˆï¸ æ—…äººè¨˜å¸³æœ¬</h1>
            <button class="nav-btn" onclick="exportBackup()">å‚™ä»½è³‡æ–™</button>
        </div>
        <div id="trip-list" style="padding-top: 20px;"></div>
        <button class="fab" onclick="showCreateModal()">ï¼‹</button>
    </div>

    <div id="page-create" class="page" style="background:white; position:fixed; inset:0; z-index:200;">
        <div class="navbar" style="background:white; color:#333; border-bottom:1px solid #eee;">
            <h1>å»ºç«‹æ–°æ—…ç¨‹</h1>
            <button class="nav-btn" style="color:#666; border:1px solid #ddd;" onclick="goHome()">å–æ¶ˆ</button>
        </div>
        <div style="padding: 20px;">
            <div class="form-group">
                <label>æ—…ç¨‹åç¨±</label>
                <input type="text" id="newTripName" placeholder="ä¾‹å¦‚ï¼š2025 åŒ—æµ·é“æ»‘é›ª">
            </div>
            <div class="form-group">
                <label>æ—…éŠæ—¥æœŸå€é–“</label>
                <div class="form-row">
                    <input type="date" id="newTripStart">
                    <input type="date" id="newTripEnd">
                </div>
            </div>
            <div class="form-group">
                <label>æ—…éŠäººæ•¸</label>
                <input type="number" id="newTripPeople" value="1" min="1">
            </div>
            <div class="form-group">
                <label>ç•¶åœ°ä¸»è¦è²¨å¹£</label>
                <select id="newTripCurrency">
                    <option value="JPY">ğŸ‡¯ğŸ‡µ æ—¥åœ“ (JPY)</option>
                    <option value="USD">ğŸ‡ºğŸ‡¸ ç¾é‡‘ (USD)</option>
                    <option value="KRW">ğŸ‡°ğŸ‡· éŸ“å…ƒ (KRW)</option>
                    <option value="EUR">ğŸ‡ªğŸ‡º æ­å…ƒ (EUR)</option>
                    <option value="CNY">ğŸ‡¨ğŸ‡³ äººæ°‘å¹£ (CNY)</option>
                    <option value="THB">ğŸ‡¹ğŸ‡­ æ³°éŠ– (THB)</option>
                    <option value="TWD">ğŸ‡¹ğŸ‡¼ å°å¹£ (TWD)</option>
                </select>
            </div>
            <button class="btn-block" onclick="createTrip()">å»ºç«‹æ—…ç¨‹</button>
        </div>
    </div>

    <div id="page-detail" class="page">
        <div class="navbar">
            <button class="nav-btn" onclick="goHome()">â¬… è¿”å›</button>
            <h1 id="detailTitle">è©³ç´°è³‡æ–™</h1>
            <button class="nav-btn" onclick="exportExcel()">åŒ¯å‡º Excel</button>
        </div>

        <div class="card" style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; margin-top: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="font-size: 14px; opacity: 0.9;">ç¸½æ”¯å‡º (TWD)</div>
                <div class="badge badge-green" style="background:rgba(255,255,255,0.2); color:white;" id="displayPeopleCount">1 äºº</div>
            </div>
            <div style="font-size: 32px; font-weight: bold; margin-top: 5px;" id="displayTotalTWD">0</div>
            <div style="margin-top: 10px; font-size: 14px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px;">
                äººå‡ï¼š NT$ <span id="displayAvgPerPerson" style="font-weight:bold;">0</span>
            </div>
        </div>

        <div class="card" id="inputCard">
            <h3 style="margin: 0 0 15px 0; font-size: 16px; color: var(--primary); display:flex; justify-content:space-between;">
                <span id="inputTitle">ğŸ–Šï¸ æ–°å¢æ¶ˆè²»</span>
                <span id="editModeIndicator" style="display:none; color:#ffc107; font-size:12px;">ç·¨è¼¯æ¨¡å¼ä¸­</span>
            </h3>
            
            <div class="form-group">
                <label>é¡åˆ¥ (åŠ ä¸Š Emoji æ›´æ¸…æ¥š)</label>
                <input type="text" id="inputCategory" list="categoryOptions" placeholder="é¸æ“‡æˆ–è¼¸å…¥">
                <datalist id="categoryOptions">
                    <option value="âœˆï¸ æ©Ÿç¥¨">
                    <option value="ğŸ¨ ä½å®¿">
                    <option value="ğŸ” é¤é£²">
                    <option value="ğŸš† äº¤é€š">
                    <option value="ğŸ›ï¸ è³¼ç‰©">
                    <option value="ğŸŸï¸ é–€ç¥¨">
                    <option value="ğŸ ä¼´æ‰‹ç¦®">
                </datalist>
            </div>

            <div class="form-group">
                <label>æ”¯ä»˜æ–¹å¼</label>
                <input type="text" id="inputPayment" list="paymentOptions" placeholder="ä¾‹å¦‚: ç¾é‡‘, ä¿¡ç”¨å¡">
                <datalist id="paymentOptions">
                    <option value="ç¾é‡‘">
                    <option value="ä¿¡ç”¨å¡">
                    <option value="Apple Pay">
                    <option value="Line Pay">
                    <option value="ICå¡/äº¤é€šå¡">
                </datalist>
            </div>

            <div class="form-group">
                <div class="currency-toggle">
                    <button class="toggle-btn active" id="btnForeign" onclick="setCurrencyMode('FOREIGN')">ç•¶åœ°è²¨å¹£</button>
                    <button class="toggle-btn" id="btnHome" onclick="setCurrencyMode('HOME')">å°å¹£æ”¯ä»˜</button>
                </div>
            </div>

            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>é‡‘é¡</label>
                    <input type="number" id="inputAmount" placeholder="é‡‘é¡">
                </div>
                <div style="flex:1;" id="rateInputGroup">
                    <label>åŒ¯ç‡</label>
                    <input type="number" id="inputRate" step="0.0001" placeholder="åŒ¯ç‡">
                </div>
            </div>

            <div class="form-group">
                <label>é …ç›®èªªæ˜</label>
                <input type="text" id="inputItem" placeholder="ä¾‹å¦‚: ä¸€è˜­æ‹‰éºµ">
            </div>
            
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="inputDate">
            </div>

            <button id="submitBtn" class="btn-block" onclick="submitExpense()">åŠ å…¥æ¸…å–®</button>
            <button id="cancelEditBtn" class="btn-block" onclick="cancelEdit()" style="display:none; background:#ccc; margin-top:10px;">å–æ¶ˆç·¨è¼¯</button>
        </div>

        <div class="card">
            <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #666;">ğŸ“Š é¡åˆ¥çµ±è¨ˆ</h3>
            <div id="chartContainer"></div>
        </div>

        <div class="card">
            <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #666;">ğŸ“œ æ˜ç´°åˆ—è¡¨</h3>
            <div id="expenseList"></div>
        </div>
    </div>
</div>

<script>
    let trips = JSON.parse(localStorage.getItem('travelApp_v8')) || [];
    let currentTripId = null;
    let editingExpenseId = null; // è¿½è¹¤æ­£åœ¨ç·¨è¼¯å“ªä¸€ç­†
    let currentMode = 'FOREIGN'; 
    const API_URL = "https://open.er-api.com/v6/latest/";

    window.onload = function() {
        renderTripList();
        document.getElementById('inputDate').valueAsDate = new Date();
    };

    function saveData() {
        localStorage.setItem('travelApp_v8', JSON.stringify(trips));
    }

    // è·¯ç”±
    function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        window.scrollTo(0,0);
    }
    function goHome() { switchPage('page-home'); renderTripList(); }
    function showCreateModal() { 
        document.getElementById('newTripName').value = ""; 
        document.getElementById('newTripStart').value = ""; 
        document.getElementById('newTripEnd').value = ""; 
        document.getElementById('newTripPeople').value = "1"; 
        switchPage('page-create'); 
    }

    // --- æ—…ç¨‹ç®¡ç† ---
    function createTrip() {
        const name = document.getElementById('newTripName').value;
        const currency = document.getElementById('newTripCurrency').value;
        const startDate = document.getElementById('newTripStart').value;
        const endDate = document.getElementById('newTripEnd').value;
        const people = Number(document.getElementById('newTripPeople').value) || 1;

        if (!name) return alert("è«‹è¼¸å…¥æ—…ç¨‹åç¨±");

        const newTrip = {
            id: Date.now(),
            name, mainCurrency: currency, startDate, endDate, people,
            createdAt: new Date().toLocaleDateString(),
            expenses: [] 
        };

        trips.push(newTrip);
        saveData();
        fetch(API_URL + currency).then(r=>r.json()).then(d=>{
            newTrip.lastRate = d.rates.TWD; saveData();
        });
        goHome();
    }

    function deleteTrip(e, id) {
        e.stopPropagation();
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ—…ç¨‹ï¼Ÿ")) {
            trips = trips.filter(t => t.id !== id);
            saveData();
            renderTripList();
        }
    }

    function renderTripList() {
        const list = document.getElementById('trip-list');
        list.innerHTML = "";
        if(trips.length === 0) { list.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">å°šæœªå»ºç«‹æ—…ç¨‹</div>`; return; }

        trips.forEach(trip => {
            const total = trip.expenses.reduce((sum, item) => sum + item.finalTWD, 0);
            const people = trip.people || 1;
            
            let dateRange = trip.createdAt;
            if(trip.startDate && trip.endDate) dateRange = `${trip.startDate} ~ ${trip.endDate}`;

            const div = document.createElement('div');
            div.className = 'trip-card card';
            div.onclick = () => openTrip(trip.id);
            div.innerHTML = `
                <div class="trip-title">${trip.name}</div>
                <button class="btn-delete-trip" onclick="deleteTrip(event, ${trip.id})">åˆªé™¤</button>
                <div class="trip-date">ğŸ“… ${dateRange} <span class="badge badge-green">${people}äºº</span></div>
                <div class="trip-meta">
                    <span class="badge badge-blue">ç¸½è¨ˆ: $${Math.round(total).toLocaleString()}</span>
                    <span>ç­†æ•¸: ${trip.expenses.length}</span>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // --- è¨˜å¸³èˆ‡ç·¨è¼¯é‚è¼¯ ---
    function openTrip(id) {
        currentTripId = id;
        cancelEdit(); // æ¸…é™¤ä»»ä½•ç·¨è¼¯ç‹€æ…‹
        const trip = trips.find(t => t.id === id);
        
        document.getElementById('detailTitle').innerText = trip.name;
        document.getElementById('displayPeopleCount').innerText = (trip.people || 1) + " äºº";
        
        // é è¨­æ—¥æœŸ
        if(trip.startDate) document.getElementById('inputDate').value = trip.startDate;
        else document.getElementById('inputDate').valueAsDate = new Date();
        
        document.getElementById('btnForeign').innerText = `ç•¶åœ° (${trip.mainCurrency})`;
        
        // åŒ¯ç‡é å¡«
        if(trip.lastRate) document.getElementById('inputRate').value = parseFloat(trip.lastRate).toFixed(4);
        setCurrencyMode('FOREIGN');

        renderDetailView();
        switchPage('page-detail');
    }

    function setCurrencyMode(mode) {
        currentMode = mode;
        const rateGroup = document.getElementById('rateInputGroup');
        if (mode === 'HOME') {
            rateGroup.style.display = 'none';
            document.getElementById('btnHome').classList.add('active');
            document.getElementById('btnForeign').classList.remove('active');
        } else {
            rateGroup.style.display = 'block';
            document.getElementById('btnForeign').classList.add('active');
            document.getElementById('btnHome').classList.remove('active');
        }
    }

    // æ–°å¢æˆ–æ›´æ–°
    function submitExpense() {
        const trip = trips.find(t => t.id === currentTripId);
        
        let category = document.getElementById('inputCategory').value || "æœªåˆ†é¡";
        let payment = document.getElementById('inputPayment').value || "ç¾é‡‘";
        const item = document.getElementById('inputItem').value || category;
        const amount = Number(document.getElementById('inputAmount').value);
        const date = document.getElementById('inputDate').value;
        
        let rate = 1;
        let finalTWD = 0;
        let currencyLabel = 'TWD';

        if (amount <= 0) return alert("è«‹è¼¸å…¥é‡‘é¡");

        if (currentMode === 'FOREIGN') {
            rate = Number(document.getElementById('inputRate').value);
            if (rate <= 0) return alert("è«‹è¼¸å…¥åŒ¯ç‡");
            finalTWD = amount * rate;
            currencyLabel = trip.mainCurrency;
            trip.lastRate = rate; 
        } else {
            finalTWD = amount;
        }

        const expenseData = {
            id: editingExpenseId ? editingExpenseId : Date.now(), // è‹¥æ˜¯ç·¨è¼¯ï¼Œæ²¿ç”¨èˆŠIDï¼›å¦å‰‡æ–°ID
            date, category, payment, item, amount, rate, currencyLabel, finalTWD
        };

        if (editingExpenseId) {
            // æ›´æ–°æ¨¡å¼: æ‰¾åˆ°èˆŠè³‡æ–™ä¸¦å–ä»£
            const index = trip.expenses.findIndex(e => e.id === editingExpenseId);
            if(index !== -1) trip.expenses[index] = expenseData;
            alert("æ›´æ–°æˆåŠŸï¼");
        } else {
            // æ–°å¢æ¨¡å¼
            trip.expenses.push(expenseData);
        }

        saveData();
        cancelEdit(); // æ¢å¾©åˆå§‹ç‹€æ…‹
        renderDetailView();
    }

    // å•Ÿå‹•ç·¨è¼¯æ¨¡å¼
    function editExpense(id) {
        const trip = trips.find(t => t.id === currentTripId);
        const exp = trip.expenses.find(e => e.id === id);
        if(!exp) return;

        // 1. å°‡è³‡æ–™å¡«å›è¡¨å–®
        document.getElementById('inputCategory').value = exp.category;
        document.getElementById('inputPayment').value = exp.payment || "ç¾é‡‘";
        document.getElementById('inputItem').value = exp.item;
        document.getElementById('inputAmount').value = exp.amount;
        document.getElementById('inputDate').value = exp.date;

        // 2. è¨­å®šå¹£åˆ¥æ¨¡å¼
        if(exp.currencyLabel === 'TWD') {
            setCurrencyMode('HOME');
        } else {
            setCurrencyMode('FOREIGN');
            document.getElementById('inputRate').value = exp.rate;
        }

        // 3. è®Šæ›´ä»‹é¢ç‹€æ…‹
        editingExpenseId = id;
        document.getElementById('submitBtn').innerText = "ç¢ºèªæ›´æ–°";
        document.getElementById('submitBtn').classList.add('edit-mode');
        document.getElementById('cancelEditBtn').style.display = 'block';
        document.getElementById('inputTitle').innerText = "âœ ç·¨è¼¯æ¶ˆè²»";
        document.getElementById('editModeIndicator').style.display = 'inline';
        
        // 4. æ»¾å‹•åˆ°è¼¸å…¥å€
        document.getElementById('inputCard').scrollIntoView({behavior: 'smooth'});
    }

    function cancelEdit() {
        editingExpenseId = null;
        document.getElementById('submitBtn').innerText = "åŠ å…¥æ¸…å–®";
        document.getElementById('submitBtn').classList.remove('edit-mode');
        document.getElementById('cancelEditBtn').style.display = 'none';
        document.getElementById('inputTitle').innerText = "ğŸ–Šï¸ æ–°å¢æ¶ˆè²»";
        document.getElementById('editModeIndicator').style.display = 'none';
        
        // æ¸…ç©ºæ¬„ä½
        document.getElementById('inputAmount').value = "";
        document.getElementById('inputItem').value = "";
        // é¡åˆ¥è·Ÿæ—¥æœŸé€šå¸¸æœƒæƒ³ä¿ç•™ï¼Œæš«ä¸æ¸…ç©º
    }

    function deleteExpense(eid) {
        if(!confirm("åˆªé™¤é€™ç­†è³‡æ–™ï¼Ÿ")) return;
        const trip = trips.find(t => t.id === currentTripId);
        trip.expenses = trip.expenses.filter(e => e.id !== eid);
        saveData();
        // å¦‚æœæ­£åœ¨ç·¨è¼¯é€™ç­†ï¼Œè¦å–æ¶ˆç·¨è¼¯
        if(editingExpenseId === eid) cancelEdit();
        renderDetailView();
    }

    function renderDetailView() {
        const trip = trips.find(t => t.id === currentTripId);
        const list = document.getElementById('expenseList');
        list.innerHTML = "";
        
        const sorted = [...trip.expenses].sort((a,b) => new Date(b.date) - new Date(a.date));

        sorted.forEach(exp => {
            const div = document.createElement('div');
            div.className = 'expense-item';
            let detail = (exp.currencyLabel === 'TWD') ? 'å°å¹£' : `${exp.amount} ${exp.currencyLabel} Ã— ${exp.rate}`;
            let payMethod = exp.payment || "ç¾é‡‘";

            div.innerHTML = `
                <div style="flex:1;">
                    <div style="font-weight:600; font-size:15px;">
                        <span class="expense-tag">${exp.category}</span> ${exp.item}
                        <span class="pay-method">${payMethod}</span>
                    </div>
                    <div style="font-size:12px; color:#888; margin-top:2px;">${exp.date} â€¢ ${detail}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:bold; color:#333;">$${Math.round(exp.finalTWD).toLocaleString()}</div>
                    <div style="margin-top:5px;">
                        <button class="action-btn btn-edit" onclick="editExpense(${exp.id})">âœ</button>
                        <button class="action-btn btn-del" onclick="deleteExpense(${exp.id})">Ã—</button>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });

        const total = trip.expenses.reduce((sum,e)=>sum+e.finalTWD,0);
        const people = trip.people || 1;
        
        document.getElementById('displayTotalTWD').innerText = Math.round(total).toLocaleString();
        document.getElementById('displayAvgPerPerson').innerText = Math.round(total / people).toLocaleString();
        renderChart(trip.expenses, total);
    }

    function renderChart(expenses, total) {
        const box = document.getElementById('chartContainer');
        box.innerHTML = "";
        if(total===0) { box.innerHTML = "<div style='text-align:center; color:#ccc; font-size:13px;'>ç„¡è³‡æ–™</div>"; return; }
        
        const map = {};
        expenses.forEach(e => { map[e.category] = (map[e.category]||0) + e.finalTWD; });
        const arr = Object.keys(map).map(k=>({n:k, v:map[k]})).sort((a,b)=>b.v-a.v);

        arr.forEach(item => {
            const pct = (item.v / total * 100).toFixed(1);
            const row = document.createElement('div');
            row.className = 'chart-row';
            row.innerHTML = `<div style="width:80px; color:#555;">${item.n}</div>
                <div class="chart-bar-bg"><div class="chart-bar-fill" style="width:${pct}%"></div></div>
                <div style="width:40px; text-align:right; font-weight:bold;">${pct}%</div>`;
            box.appendChild(row);
        });
    }

    function exportExcel() {
        const trip = trips.find(t => t.id === currentTripId);
        if (trip.expenses.length === 0) return alert("ç„¡è³‡æ–™");
        const data = trip.expenses.map(e => ({
            "æ—¥æœŸ": e.date, "é¡åˆ¥": e.category, "é …ç›®": e.item, 
            "æ”¯ä»˜æ–¹å¼": e.payment || "ç¾é‡‘",
            "å¹£åˆ¥": e.currencyLabel, "åŸå¹£": e.amount, "åŒ¯ç‡": e.rate, "å°å¹£": Math.round(e.finalTWD)
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æ”¯å‡º");
        XLSX.writeFile(wb, `${trip.name}_å®Œæ•´å ±è¡¨.xlsx`);
    }

    function exportBackup() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(trips)],{type:"application/json"}));
        a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }
</script>
</body>
</html>